Title : XMC 4500 ADC Intro

Author : Gert van Biljon

EMail : gertvb@gmail.com

What am I : Demo project to illustrate the continuous transfer of VADC values with DMA in Infineon's DAVE 4.4.2 on an
            XMC4500 Relax Lite

DAVE 4.4.2 reconfigure : To reduce the size of the archive I had to delete some of the files Generated by DAVE, and before you
                         can run this project there are a few hurdles you have to cross.

                         1.  Unzip the .7z archive into your DAVE Workspace
                         2.  Open the project from within DAVE
                         3.  Generate code, to recreate the deleted files : Menu -> DAVE -> Generate Code
                         4.  Set your build configuration to Debug : Project explorer -> select this project ->
                                                                     -> Right click for context menu -> Build Configuration ->
                                                                     -> Set active -> Debug
                         5.  Rebuild
                         6.  Debug and run

How I work : 1.  6 X ANALOG_IO connected to pins 14.0/1/2 for VADC group 0 and 14.4/5/15.2 for VADC group 2
             2.  2 X VADC groups, Group 0 and Group 2
                 Both set up with: Scan Request Source, with Autoscan selected to keep on scanning
                                   3 Channels for each group, reading in order of Channel 2, 1, 0
                                   Channel 2 result register is GxRES2 group result register, CH1 GxRES1, CH0 GxRES0, the 3
                                   channels you select must be consecutive channels, as the DMA requires continuous addresses
                                   GxRES0 for each group set to generate a result event
                                   Arbitration selected for Slot 1, Scan request source                                                                                                                   *
             3.  2 X DMA channels
                 Multiblock transfer with source and destination address reload, and Block size of 3
                 Source and destination addresses increment, with a transfer width of 16bits, which is the size of the ADC result
                 See below the definition of ADC_G0_results[3], ADC_G0_DMA_0_Destination_Address and ADC_G0_DMA_0_Source_Address
             4.  IMPORTANT: DMA Source Gather, the VADC result in memory is a 32bit value, with the lower 16bits containing the
                 actual ADC result and the higher 16 bits containing the status of the result.  You are only interested in the
                 16bit result value, and not in the status value.  If you read the values as 16bit consecutive values your
                 result array[0] is going to contain the first adc[0] value, array[1] is going to contain the adc status of the
                 first adc[0] result, array[2] is going to contain the next adc[1] value. To cater for a situation like this you
                 can transfer 32bit values, and mask the top 16bits out, or use the gather functionality with an interval of 1,
                 which will in effect read a 16 bit value, skip the next 16 bit value, read the next 16 bit value, skip the next
                 16bit value - which is a VERY handy feature!
             5.  Each DMA channel is triggered on the VADC group's channel 0 result event
             6.  I have also added 2 Interrupts that are also triggered on each VADC channel 0 result event, I just toggle the
                 LEDs as an indication of activity on the VADC - THIS IS NOT NEEDED FOR THE VADC TO TRANSFER VIA DMA
             7.  On either of the button presses I output the result values to the terminal connected to the USB serial port,
                 my terminal of choice is TeraTerm

Additional references : 1. AP32305 : Versatile Analog to Digital Converter (VADC)
                           https://www.infineon.com/dgdl/Infineon-VADC-XMC4000-AP32305-AN-v01_02-EN.pdf?fileId=5546d4624e765da5014ed98b2c043824
                           Particularly page 37, pin assignments for ADC group channels
                        2. AP32290 : General purpose Direct Memory Access (GPDMA)
                           https://www.infineon.com/dgdl/Infineon-GPDMA-XMC4000-AP32290-AN-v01_00-EN.pdf?fileId=5546d4624e765da5014ed9145c601e95
                           Page 10, Gather transfers explanation
                           Page 19 Figure 16, Gather transfer, specifically with VADC result registers
                        3. XMC4500 Data Sheet
                           https://www.infineon.com/dgdl/Infineon-XMC4500-DS-v01_05-EN.pdf?fileId=5546d46254e133b40154e1b56cbe0123
                           Particularly page 19-103 detailing the result registers

Problems : while(!USBD_VCOM_IsEnumDone()); hangs if no usb is connected, problem specific to the Relax kit, where the power line
           from the USB can come from 2 different inputs, and you cannot check if the plug is disconnected......

Todo : 1.  Additional dma channel to xfer the systick value so I can add a timestamp to an adc value
       2.  Synchronous readings between VADC groups

Copying, sharing and using : No limits whatsoever, please copy, use and share.

Why : I am publishing this in the hope that it will ease somebody's way out of the frustration of getting an ADC and DMA working
      together in DAVE 4.4.2 as there are plenty samples, but no example that I could find that specifically uses the DAVE 4.4.2
      VADC and DMA APPS

I would appreciate it plenty if you would bless me with a coffee/pizza/bucket full of Euros via Paypal, as I am willing to bet
that this is saving you at least 20 professional development hours where you don't have to battle to figure out the DMA and VADC

Kind regards from South Africa

Gert van Biljon
